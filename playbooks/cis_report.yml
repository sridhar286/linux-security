- name: CIS Compliance Report â€“ Per Host
  hosts: cis_targets
  become: true
  gather_facts: false

  tasks:
    # --- SSH ---
    - name: Check SSH root login
      shell: sshd -T | grep -i permitrootlogin
      register: ssh_root
      changed_when: false
      failed_when: false

    - set_fact:
        ssh_status: "{{ 'COMPLIANT' if 'permitrootlogin no' in ssh_root.stdout else 'NON-COMPLIANT' }}"

    # --- PAM ---
    - name: Check password aging
      shell: grep '^PASS_MAX_DAYS' /etc/login.defs
      register: pam_days
      changed_when: false
      failed_when: false

    - set_fact:
        pam_status: "{{ 'COMPLIANT' if '90' in pam_days.stdout else 'NON-COMPLIANT' }}"

    # --- AUDITD ---
    - name: Check auditd rules loaded
      shell: auditctl -l | wc -l
      register: audit_rules
      changed_when: false
      failed_when: false

    - set_fact:
        audit_status: "{{ 'COMPLIANT' if audit_rules.stdout|int > 0 else 'NON-COMPLIANT' }}"

    # --- FIREWALL ---
    - name: Check firewalld running
      command: systemctl is-active firewalld
      register: fw_status
      changed_when: false
      failed_when: false

    - set_fact:
        firewall_status: "{{ 'COMPLIANT' if fw_status.stdout == 'active' else 'NON-COMPLIANT' }}"

    # --- SYSCTL ---
    - name: Check rp_filter
      command: sysctl net.ipv4.conf.all.rp_filter
      register: rp_filter
      changed_when: false
      failed_when: false

    - set_fact:
        sysctl_status: "{{ 'COMPLIANT' if '= 1' in rp_filter.stdout else 'NON-COMPLIANT' }}"

    # --- FINAL SUMMARY ---
    - name: CIS Compliance Summary
      debug:
        msg:
          - "Host: {{ inventory_hostname }}"
          - "SSH: {{ ssh_status }}"
          - "PAM: {{ pam_status }}"
          - "AUDITD: {{ audit_status }}"
          - "FIREWALL: {{ firewall_status }}"
          - "SYSCTL: {{ sysctl_status }}"
